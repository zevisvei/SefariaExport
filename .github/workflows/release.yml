name: Python 3.9 + MongoDB + Sefaria Export (Manual)

on:
  # Manual trigger from the Actions tab
  workflow_dispatch:
    inputs:
      export_function:
        description: "Which export to run (export_all, export_texts, export_all_merged, export_links, export_schemas, export_toc, export_topic_graph)"
        required: false
        default: "export_all"
      timezone:
        description: "Timezone for timestamp/tag (IANA name)"
        required: false
        default: "Asia/Jerusalem"

# Needed to create a release
permissions:
  contents: write

jobs:
  export:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        # Healthcheck runs inside the container; Actions will wait for 'healthy'
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=20

    env:
      # Resolve inputs (fallbacks for manual run)
      EXPORT_FUNCTION: ${{ inputs.export_function || 'export_all' }}
      TZ_NAME: ${{ inputs.timezone || 'Asia/Jerusalem' }}
      # Django needs this to load the project settings
      DJANGO_SETTINGS_MODULE: sefaria.settings
      # Local export folder used by export.py via settings
      SEFARIA_EXPORT_PATH: ${{ github.workspace }}/exports
      # Mongo connection (DB "sefaria" comes from the dump)
      MONGO_HOST: 127.0.0.1
      MONGO_PORT: 27017
      MONGO_DB_NAME: sefaria

    steps:
      - name: Checkout (this repository)
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install system helpers (wget, tar, zip, nc)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget ca-certificates zip netcat-openbsd

      - name: Install MongoDB Database Tools (mongorestore)
        run: |
          TOOLS_VER="100.9.4"
          wget -q https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}.tgz
          tar -xzf mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}.tgz
          sudo mv mongodb-database-tools-ubuntu2204-x86_64-${TOOLS_VER}/bin/* /usr/local/bin/
          mongorestore --version

      - name: Clone Sefaria-Project
        run: |
          git clone --depth 1 https://github.com/Sefaria/Sefaria-Project.git
          ls -la Sefaria-Project

      - name: Install Python deps of Sefaria-Project
        working-directory: Sefaria-Project
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create minimal local_settings.py
        working-directory: Sefaria-Project/sefaria
        run: |
          cp local_settings_example.py local_settings.py
          python - <<'PY'
          import os, re
          p = "local_settings.py"
          with open(p, "r", encoding="utf-8") as f:
              s = f.read()
          s = re.sub(r"SEFARIA_EXPORT_PATH\s*=.*", f'SEFARIA_EXPORT_PATH = r"{os.environ["SEFARIA_EXPORT_PATH"]}"', s)
          s = re.sub(r"MONGO_HOST\s*=.*", f'MONGO_HOST = "{os.environ["MONGO_HOST"]}"', s)
          s = re.sub(r"MONGO_PORT\s*=.*", f'MONGO_PORT = {int(os.environ["MONGO_PORT"])}', s)
          s = re.sub(r"MONGO_DB_NAME\s*=.*", f'MONGO_DB_NAME = "{os.environ["MONGO_DB_NAME"]}"', s)
          with open(p, "w", encoding="utf-8") as f:
              f.write(s)
          print("local_settings.py written with CI values")
          PY

      - name: Wait for MongoDB TCP (extra safety)
        run: |
          for i in {1..60}; do
            if nc -z 127.0.0.1 27017; then
              echo "✅ MongoDB TCP port is reachable"; break
            fi
            echo "⏳ Waiting for MongoDB TCP..."; sleep 2
          done

      - name: Fetch official dump (Sefaria-Export) and restore
        run: |
          git clone --depth 1 https://github.com/Sefaria/Sefaria-Export.git
          mongorestore --host 127.0.0.1 --port 27017 --drop Sefaria-Export/dump

      - name: Run export function
        working-directory: Sefaria-Project
        env:
          PYTHONPATH: ${{ github.workspace }}/Sefaria-Project
        run: |
          mkdir -p "$SEFARIA_EXPORT_PATH"
          echo "Requested export function: $EXPORT_FUNCTION"
          python - <<'PY'
          import os, sys, django
          sys.path.insert(0, os.path.abspath("."))
          os.environ.setdefault("DJANGO_SETTINGS_MODULE", "sefaria.settings")
          os.environ.setdefault("SEFARIA_EXPORT_PATH", os.environ.get("SEFARIA_EXPORT_PATH"))
          django.setup()
          from sefaria import export as ex

          fn = os.environ.get("EXPORT_FUNCTION","export_all").strip()
          allowed = {
            "export_all": ex.export_all,
            "export_texts": ex.export_texts,
            "export_all_merged": ex.export_all_merged,
            "export_links": ex.export_links,
            "export_schemas": ex.export_schemas,
            "export_toc": ex.export_toc,
            "export_topic_graph": ex.export_topic_graph,
          }
          if fn not in allowed:
              raise SystemExit(f"Unknown export function: {fn}")
          allowed[fn]()
          print(f"✅ {fn} completed.")
          PY
          echo "Exported content path: $SEFARIA_EXPORT_PATH"
          ls -la "$SEFARIA_EXPORT_PATH" || true

      - name: Compute release timestamp (from input timezone)
        id: ts
        run: |
          TZ="${TZ_NAME}" date '+%Y-%m-%d_%H-%M' > ts.txt
          echo "stamp=$(cat ts.txt)" >> $GITHUB_OUTPUT
          echo "Release timestamp (${TZ_NAME}): $(cat ts.txt)"

      - name: Zip exports
        id: zip
        run: |
          cd "$(dirname "$SEFARIA_EXPORT_PATH")"
          ZIP_NAME="sefaria-exports-${{ steps.ts.outputs.stamp }}.zip"
          zip -r "$ZIP_NAME" "$(basename "$SEFARIA_EXPORT_PATH")"
          echo "ZIP_PATH=$(pwd)/$ZIP_NAME" >> $GITHUB_ENV
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
          ls -lh "$ZIP_NAME"

      - name: Upload artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.zip.outputs.zip_name }}
          path: ${{ env.ZIP_PATH }}

      - name: Create GitHub Release (tag = date-hour; name = date-hour)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ts.outputs.stamp }}
          name: ${{ steps.ts.outputs.stamp }}
          files: ${{ env.ZIP_PATH }}
          body: "Automated Sefaria export (${{ env.EXPORT_FUNCTION }}) generated at ${{ env.TZ_NAME }} time: ${{ steps.ts.outputs.stamp }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
